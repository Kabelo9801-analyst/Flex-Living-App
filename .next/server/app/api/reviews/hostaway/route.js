"use strict";(()=>{var e={};e.id=461,e.ids=[461],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3977:e=>{e.exports=require("node:fs/promises")},9411:e=>{e.exports=require("node:path")},5772:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>C,patchFetch:()=>x,requestAsyncStorage:()=>b,routeModule:()=>y,serverHooks:()=>A,staticGenerationAsyncStorage:()=>k});var r={};a.r(r),a.d(r,{GET:()=>v});var n=a(9303),i=a(8716),o=a(670),s=a(7070),l=a(5327),u=a(3977),c=a.n(u),g=a(9411),d=a.n(g);let p="https://api.hostaway.com/v1";async function h(){let e=process.env.HOSTAWAY_ACCOUNT_ID,t=process.env.HOSTAWAY_API_KEY;if(!e||!t)return null;try{let a=new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t,scope:"general"}),r=await fetch(`${p}/accessTokens`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a});if(!r.ok)throw Error(`Token error: ${r.status}`);let n=await r.json();return n?.access_token||null}catch(e){return console.warn("Hostaway token error",e),null}}async function f(e,t){if(!e)return{status:"fail",result:[]};let a=new URL(`${p}/reviews`);for(let e of["listingMapIds[]","limit","offset","sortBy","sortOrder","reservationId","type","statuses[]","from","to"])t.has(e)&&a.searchParams.set(e,t.get(e));let r=await fetch(a.toString(),{headers:{Authorization:`Bearer ${e}`}});return r.ok?r.json():{status:"fail",result:[]}}async function w(){let e=d().join(process.cwd(),"data","mockReviews.json");try{let t=await c().readFile(e,"utf-8");return JSON.parse(t)}catch{return[]}}async function m(){try{let e=await c().readFile(d().join(process.cwd(),"data","approved.json"),"utf-8");return JSON.parse(e)}catch{return{}}}async function v(e){let{searchParams:t}=new URL(e.url),a=await h(),r=await f(a,t).catch(()=>({status:"fail",result:[]})),n=Array.isArray(r?.result)?r.result:[],i=await w(),o=n.length?n:i,u=await m(),c=t.get("channel"),g=t.get("type"),d=t.get("status"),p=t.get("from")?new Date(t.get("from")):null,v=t.get("to")?new Date(t.get("to")):null,y=t.get("q")?.toLowerCase(),b=o.map(e=>(0,l.T8)(e,u));c&&(b=b.filter(e=>e.channel.toLowerCase()===c.toLowerCase())),g&&(b=b.filter(e=>(e.reviewType||"").toLowerCase()===g.toLowerCase())),d&&(b=b.filter(e=>(e.status||"").toLowerCase()===d.toLowerCase())),p&&(b=b.filter(e=>new Date(e.publishedAt)>=p)),v&&(b=b.filter(e=>new Date(e.publishedAt)<=v)),y&&(b=b.filter(e=>(e.text||"").toLowerCase().includes(y)));let k="1"===t.get("summary")?{reviews:b,summary:(0,l.dU)(b)}:{reviews:b};return s.NextResponse.json(k,{headers:{"Cache-Control":"no-store"}})}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reviews/hostaway/route",pathname:"/api/reviews/hostaway",filename:"route",bundlePath:"app/api/reviews/hostaway/route"},resolvedPagePath:"/Users/kvbiila/Downloads/flex-living-reviews-dashboard/app/api/reviews/hostaway/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:b,staticGenerationAsyncStorage:k,serverHooks:A}=y,C="/api/reviews/hostaway/route";function x(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:k})}},5327:(e,t,a)=>{a.d(t,{dU:()=>p,Uf:()=>d,T8:()=>g});let r={2005:"Airbnb",2001:"Booking.com",2010:"Vrbo",2007:"Hostaway",2002:"Expedia",2013:"Marriott"},n=e=>e||0===e?r[e]||`Channel ${e}`:"Unknown",i=["great","amazing","awesome","clean","spotless","friendly","helpful","perfect","excellent","fantastic","spacious","cozy","quiet","recommend","comfortable","love"],o=["bad","dirty","smell","noisy","rude","terrible","awful","disappoint","broken","unsafe","issue","problem","bug","delay","poor","worst"];function s(e){let t=(e||"").toLowerCase(),a=0;for(let e of i)t.includes(e)&&(a+=1);for(let e of o)t.includes(e)&&(a-=1);let r=a>0?"positive":a<0?"negative":"neutral";return{score:a,label:r}}let l={Cleanliness:["clean","spotless","dirty","dust","smell","stain"],Communication:["communication","responsive","respond","quick","host"],"Check-in":["check-in","checkin","self check","lockbox","code"],Accuracy:["accurate","exactly as","as described","misleading"],Location:["location","area","neighborhood","central","walk","metro"],Value:["value","price","worth"],Amenities:["amenities","kitchen","coffee","towels","hairdryer","washer","dryer"],Noise:["noise","noisy","quiet","street","traffic"],WiFi:["wifi","wi-fi","internet","speed"],Comfort:["bed","comfortable","mattress","pillow","sofa","shower"],Parking:["parking","garage","park"],Host:["host","helpful","friendly","rude"],Heating:["heating","heater","radiator"],AC:["ac","air conditioning","aircon"],Safety:["safe","unsafe","security"]},u=e=>{if(!e)return new Date(0).toISOString();let t=new Date(e);return isNaN(t.getTime())?new Date(0).toISOString():t.toISOString()},c=e=>null==e?null:Math.round(10*Math.max(1,Math.min(5,Number(e))))/10;function g(e,t){let a=(e.publicReview||e.privateFeedback||"").toString().trim(),r=h(a),i=s(a),o=`hostaway:${e.id}`;return{id:o,source:"hostaway",listingId:e.listingMapId,listingName:e.listingName||`Listing ${e.listingMapId}`,channel:n(e.channelId),reviewType:e.type,status:e.status,rating:c(e.rating),title:null,text:a,language:e.language||null,publishedAt:u(e.departureDate||e.arrivalDate),author:e.guestName||null,categories:r,sentiment:i,approved:!!t[o],url:null}}function d(e,t,a,r,n={}){let i=`google:${e.name||e.reviewId||e.createTime}`,o=e.text?.text||e.text||"",l=h(o),g=s(o);return{id:i,source:"google",listingId:t,listingName:a,channel:"Google",rating:c(e.rating),title:null,text:o,language:e.originalText?.languageCode||e.languageCode||null,publishedAt:u(e.createTime||e.relativePublishTimeDescription),author:e.authorAttribution?.displayName||null,categories:l,sentiment:g,approved:!!n[i],url:e.authorAttribution?.uri||r||null}}function p(e){let t={};for(let a of e){let e=String(a.listingId);t[e]||(t[e]={listingId:a.listingId,listingName:a.listingName,count:0,avgRating:null,posPct:0,negPct:0,latest:null,channels:{},topIssues:[]});let r=t[e];if(r.count+=1,null!=a.rating){let e=(r.avgRating||0)*(r.count-1)+a.rating;r.avgRating=Math.round(e/r.count*100)/100}let n=new Date(a.publishedAt).toISOString();(!r.latest||n>r.latest)&&(r.latest=n),r.channels[a.channel]=(r.channels[a.channel]||0)+1}for(let a of Object.keys(t)){let r={},n=e.filter(e=>String(e.listingId)===a).length,i=0,o=0;for(let t of e.filter(e=>String(e.listingId)===a))for(let e of("positive"===t.sentiment.label&&i++,"negative"===t.sentiment.label&&o++,t.categories))r[e]=(r[e]||0)+1;t[a].posPct=n?Math.round(i/n*100):0,t[a].negPct=n?Math.round(o/n*100):0,t[a].topIssues=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,3).map(([e,t])=>({category:e,count:t}))}let a=e.map(e=>e.rating).filter(e=>null!=e);return{byListing:t,overall:{total:e.length,avgRating:a.length?Math.round(a.reduce((e,t)=>e+t,0)/a.length*100)/100:null,posPct:e.length?Math.round(e.filter(e=>"positive"===e.sentiment.label).length/e.length*100):0,negPct:e.length?Math.round(e.filter(e=>"negative"===e.sentiment.label).length/e.length*100):0}}}function h(e){let t=(e||"").toLowerCase(),a=[];for(let[e,r]of Object.entries(l))r.some(e=>t.includes(e))&&a.push(e);return Array.from(new Set(a))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(5772));module.exports=r})();